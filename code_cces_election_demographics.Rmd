---
title: "Whose Destiny Did Demographics Decide?:\nVisualizing the 2020 Cooperative Election Study (CCES)\n"
author: "Bradley Wascher"
date: "Originally 5/17/2021"
output: prettydoc::html_pretty
theme: hpstr
---

```{r, include=FALSE}
#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ###
# Setup and startup---------------------------------------------------------------------
#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ###

### About ###
# This script processes and visualizes survey results from the Cooperative Election Study (CES/CCES),
# demonstrating how different demographic coalitions voted in the 2008â€“2020 presidential elections.
# The first half of the code wrangles the survey microdata, while the second half outputs various charts.
# Because the script is saved as a .Rmarkdown file, it can only be viewed as intended after being knit. 
# This was for a data visualization elective in graduate school. 

### Data Sources ###
# Cooperative Election Study: https://cces.gov.harvard.edu/
# MIT Election Lab: https://dataverse.harvard.edu/dataverse/electionscience


knitr::opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse) # install.packages("tidyverse")
library(survey)    # install.packages("survey")
library(dataverse) # install.packages("dataverse")
library(haven)     # install.packages("haven")
library(usmap)     # install.packages("usmap")
library(prettydoc) # install.packages("prettydoc")
library(cowplot)   # install.packages("cowplot")
library(extrafont) # install.packages("extrafont")
library(ggrepel)   # install.packages("ggrepel")

options(scipen = 999)
Sys.setenv("DATAVERSE_SERVER" = "dataverse.harvard.edu")
```

```{r, results = F}
#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ###
# Wrangling and weighting CCES data ----------------------------------------------------
#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ###

# Reading in dataset of all CCES data 2006-2021
CCESall <- get_dataframe_by_name(filename = "cumulative_2006-2021.dta",
                                dataset = "10.7910/DVN/II2DB6",
                                .f = haven::read_dta,
                                original = TRUE)


# Wrangling CCES: Recoding variables as necessary
CCESall_recode <- CCESall %>%
  mutate(candidate08      = as_factor(voted_pres_08),
         candidate12      = as_factor(voted_pres_12),
         candidate16      = as_factor(voted_pres_16),
         candidate20      = as_factor(voted_pres_20),
         state_label      = as_factor(state),
         gender_label     = as_factor(gender),
         race_label       = as_factor(race),
         age              = ifelse(year == 2020, 2020 - birthyr,
                            ifelse(year == 2016, 2016 - birthyr,
                            ifelse(year == 2012, 2012 - birthyr,
                            ifelse(year == 2008, 2008 - birthyr, NA)))), 
         age_bucket       = ifelse(age >= 18 & age <= 34, "18-34", 
                            ifelse(age >= 35 & age <= 49, "35-49",      
                            ifelse(age >= 50 & age <= 64, "50-64",
                            ifelse(age >= 65, "65+", NA)))),
         college_degree   = ifelse(educ >= 1 & educ <= 4, "No Bachelor's Degree", 
                            ifelse(educ >= 5 & educ <= 6, "Bachelor's Degree", NA)),
         race_recoded     = ifelse(race == 1, "White",
                            ifelse(race == 2, "Black",
                            ifelse(race == 3, "Hispanic",
                            ifelse(race == 4, "Asian",
                            ifelse(race >= 5 & race <= 8, "Other", NA))))))
levels(CCESall_recode$gender_label)[match("Male",levels(CCESall_recode$gender_label))] <- "Men"
levels(CCESall_recode$gender_label)[match("Female",levels(CCESall_recode$gender_label))] <- "Women"
levels(CCESall_recode$candidate08)[match("Barack Obama",levels(CCESall_recode$candidate08))] <- "Obama\n(2008)"
levels(CCESall_recode$candidate08)[match("John McCain",levels(CCESall_recode$candidate08))] <- "McCain\n(2008)"
levels(CCESall_recode$candidate12)[match("Barack Obama",levels(CCESall_recode$candidate12))] <- "Obama\n(2012)"
levels(CCESall_recode$candidate12)[match("Mitt Romney",levels(CCESall_recode$candidate12))] <- "Romney\n(2012)"
levels(CCESall_recode$candidate16)[match("Hilary Clinton",levels(CCESall_recode$candidate16))] <- "Clinton\n(2016)"
levels(CCESall_recode$candidate16)[match("Donald Trump",levels(CCESall_recode$candidate16))] <- "Trump\n(2016)"
levels(CCESall_recode$candidate20)[match("Joe Biden",levels(CCESall_recode$candidate20))] <- "Biden\n(2020)"
levels(CCESall_recode$candidate20)[match("Donald Trump",levels(CCESall_recode$candidate20))] <- "Trump\n(2020)"


# Weighting CCES for each election year 2008, 2012, 2016, 2020 
CCES08_recode <- CCESall_recode %>%
  filter(candidate08 == "Obama\n(2008)" | candidate08 == "McCain\n(2008)" | candidate08 == "Other / Someone Else") %>%
  droplevels(CCESall_recode$candidate08)
CCES08_weight <- svydesign(data = CCES08_recode, ids = ~1, weights = CCES08_recode$weight)

CCES12_recode <- CCESall_recode %>%
  filter(candidate12 == "Obama\n(2012)" | candidate12 == "Romney\n(2012)" | candidate12 == "Other / Someone Else") %>%
  droplevels(CCESall_recode$candidate12)
CCES12_weight <- svydesign(data = CCES12_recode, ids = ~1, weights = CCES12_recode$weight)

CCES16_recode <- CCESall_recode %>%
  filter(candidate16 == "Clinton\n(2016)" | candidate16 == "Trump\n(2016)" | candidate16 == "Other / Someone Else") %>%
  droplevels(CCESall_recode$candidate16)
CCES16_weight <- svydesign(data = CCES16_recode, ids = ~1, weights = CCES16_recode$weight)

CCES20_recode <- CCESall_recode %>%
  filter(candidate20 == "Biden\n(2020)" | candidate20 == "Trump\n(2020)" | candidate20 == "Other / Someone Else") %>%
  droplevels(CCESall_recode$candidate20)
CCES20_weight <- svydesign(data = CCES20_recode, ids = ~1, weights = CCES20_recode$weight)


# Wrangling data in tabular form (these objects will eventually be used to plot)

# Formatting results of 2008, 2012, 2016, 2020 election as tables: by gender
table08_gender <- prop.table(svytable(~candidate08+gender_label, CCES08_weight),2) %>%
  as.data.frame() %>%
  filter(candidate08        == "Obama\n(2008)"   | candidate08        == "McCain\n(2008)") %>%
  mutate(cycle = 2008) %>% 
  rename(candidate = candidate08)

table12_gender <- prop.table(svytable(~candidate12+gender_label, CCES12_weight),2) %>%
  as.data.frame() %>%
  filter(candidate12        == "Obama\n(2012)"   | candidate12        == "Romney\n(2012)") %>%
  mutate(cycle = 2012) %>%
  rename(candidate = candidate12)

table16_gender <- prop.table(svytable(~candidate16+gender_label, CCES16_weight),2) %>%
  as.data.frame() %>%
  filter(candidate16        == "Clinton\n(2016)" | candidate16        == "Trump\n(2016)") %>%
  mutate(cycle = 2016) %>%
  
  rename(candidate = candidate16)
table20_gender <- prop.table(svytable(~candidate20+gender_label, CCES20_weight),2) %>%
  as.data.frame() %>%
  filter(candidate20        == "Biden\n(2020)"   | candidate20        == "Trump\n(2020)") %>%
  mutate(cycle = 2020) %>%
  rename(candidate = candidate20)

tableall_gender <- table08_gender %>% rbind(table12_gender,table16_gender,table20_gender) %>%
  mutate(party = ifelse(candidate == "Obama\n(2008)" | candidate == "Obama\n(2012)"  | candidate == "Clinton\n(2016)" | candidate == "Biden\n(2020)", "Democratic", 
                 ifelse(candidate == "McCain\n(2008)"| candidate == "Romney\n(2012)" | candidate == "Trump\n(2016)"   | candidate == "Trump\n(2020)", "Republican", NA)))

rm(table08_gender,table12_gender,table16_gender,table20_gender)


# Formatting results of 2008, 2012, 2016, 2020 election as tables: by age
table08_age_bucket <- prop.table(svytable(~candidate08+age_bucket, CCES08_weight),2) %>%
  as.data.frame() %>%
  filter(candidate08        == "Obama\n(2008)"   | candidate08        == "McCain\n(2008)") %>%
  mutate(cycle = 2008) %>% 
  rename(candidate = candidate08)

table12_age_bucket <- prop.table(svytable(~candidate12+age_bucket, CCES12_weight),2) %>%
  as.data.frame() %>%
  filter(candidate12        == "Obama\n(2012)"   | candidate12        == "Romney\n(2012)") %>%
  mutate(cycle = 2012) %>%
  rename(candidate = candidate12)

table16_age_bucket <- prop.table(svytable(~candidate16+age_bucket, CCES16_weight),2) %>%
  as.data.frame() %>%
  filter(candidate16        == "Clinton\n(2016)" | candidate16       == "Trump\n(2016)") %>%
  mutate(cycle = 2016) %>%
  rename(candidate = candidate16)

table20_age_bucket <- prop.table(svytable(~candidate20+age_bucket, CCES20_weight),2) %>%
  as.data.frame() %>%
  filter(candidate20        == "Biden\n(2020)"   | candidate20        == "Trump\n(2020)") %>%
  mutate(cycle = 2020) %>%
  rename(candidate = candidate20)

tableall_age_bucket <- table08_age_bucket %>% rbind(table12_age_bucket,table16_age_bucket,table20_age_bucket) %>%
  mutate(party = ifelse(candidate == "Obama\n(2008)" | candidate == "Obama\n(2012)"  | candidate == "Clinton\n(2016)" | candidate     == "Biden\n(2020)", "Democratic", 
                 ifelse(candidate == "McCain\n(2008)"| candidate == "Romney\n(2012)" | candidate == "Trump\n(2016)"   | candidate     == "Trump\n(2020)", "Republican", NA)))

rm(table08_age_bucket,table12_age_bucket,table16_age_bucket,table20_age_bucket)


# Formatting results of 2008, 2012, 2016, 2020 election as tables: by education
table08_education <- prop.table(svytable(~candidate08+college_degree, CCES08_weight),2) %>%
  as.data.frame() %>%
  filter(candidate08        == "Obama\n(2008)"   | candidate08        == "McCain\n(2008)") %>%
  mutate(cycle = 2008) %>% 
  rename(candidate = candidate08)

table12_education <- prop.table(svytable(~candidate12+college_degree, CCES12_weight),2) %>%
  as.data.frame() %>%
  filter(candidate12        == "Obama\n(2012)"   | candidate12        == "Romney\n(2012)") %>%
  mutate(cycle = 2012) %>%
  rename(candidate = candidate12)

table16_education <- prop.table(svytable(~candidate16+college_degree, CCES16_weight),2) %>%
  as.data.frame() %>%
  filter(candidate16        == "Clinton\n(2016)" | candidate16        == "Trump\n(2016)") %>%
  mutate(cycle = 2016) %>%
  rename(candidate = candidate16)

table20_education <- prop.table(svytable(~candidate20+college_degree, CCES20_weight),2) %>%
  as.data.frame() %>%
  filter(candidate20        == "Biden\n(2020)"   | candidate20        == "Trump\n(2020)") %>%
  mutate(cycle = 2020) %>%
  rename(candidate = candidate20)

tableall_education <- table08_education %>% rbind(table12_education,table16_education,table20_education) %>%
  mutate(party = ifelse(candidate == "Obama\n(2008)" | candidate == "Obama\n(2012)"  | candidate == "Clinton\n(2016)" | candidate == "Biden\n(2020)", "Democratic", 
                 ifelse(candidate == "McCain\n(2008)"| candidate == "Romney\n(2012)" | candidate == "Trump\n(2016)"   | candidate == "Trump\n(2020)", "Republican", NA)))

rm(table08_education,table12_education,table16_education,table20_education)


# Formatting results of 2008, 2012, 2016, 2020 election as tables: by race
table08_race <- prop.table(svytable(~candidate08+race_recoded, CCES08_weight),2) %>%
  as.data.frame() %>%
  filter(candidate08        == "Obama\n(2008)"   | candidate08        == "McCain\n(2008)") %>%
  mutate(cycle = 2008) %>% 
  rename(candidate = candidate08)

table12_race <- prop.table(svytable(~candidate12+race_recoded, CCES12_weight),2) %>%
  as.data.frame() %>%
  filter(candidate12        == "Obama\n(2012)"   | candidate12        == "Romney\n(2012)") %>%
  mutate(cycle = 2012) %>%
  rename(candidate = candidate12)

table16_race <- prop.table(svytable(~candidate16+race_recoded, CCES16_weight),2) %>%
  as.data.frame() %>%
  filter(candidate16        == "Clinton\n(2016)" | candidate16        == "Trump\n(2016)") %>%
  mutate(cycle = 2016) %>%
  rename(candidate = candidate16)

table20_race <- prop.table(svytable(~candidate20+race_recoded, CCES20_weight),2) %>%
  as.data.frame() %>%
  filter(candidate20        == "Biden\n(2020)"   | candidate20        == "Trump\n(2020)") %>%
  mutate(cycle = 2020) %>%
  rename(candidate = candidate20)

tableall_race <- table08_race %>% rbind(table12_race,table16_race,table20_race) %>%
  mutate(party = ifelse(candidate == "Obama\n(2008)" | candidate == "Obama\n(2012)"  | candidate == "Clinton\n(2016)" | candidate     == "Biden\n(2020)", "Democratic", 
                 ifelse(candidate == "McCain\n(2008)"| candidate == "Romney\n(2012)" | candidate == "Trump\n(2016)"   | candidate     == "Trump\n(2020)", "Republican", NA)))
tableall_race$race_recoded <- factor(tableall_race$race_recoded, levels=c("White", "Black", "Hispanic", "Asian", "Other"))

rm(table08_race,table12_race,table16_race,table20_race)


# Formatting results of 2020 election as a table: by state
table20_bystate <- prop.table(svytable(~candidate20+state_label, CCES20_weight),2) %>%
  as.data.frame() %>%
  filter(candidate20 == "Biden\n(2020)" | candidate20 == "Trump\n(2020)")
table20_bystate$cycle <- 2020
table20_bystate <- table20_bystate[1:102,]
table20_bystate$state_label <- state.abb[match(table20_bystate$state_label,state.name)]
table20_bystate[17:18,2] <- "DC"

table20_bystate <- table20_bystate %>%
  spread(candidate20, Freq) %>%
  mutate(cces_estimate = `Biden\n(2020)` - `Trump\n(2020)`) %>%
  select(state_label, cces_estimate)


# Getting the actual state-by-state results of the 2020 election 
electionresults_all <-get_dataframe_by_name(filename = "1976-2020-president.tab",
                                            dataset = "10.7910/DVN/42MVDX")

electionresults_20 <- electionresults_all %>%
  filter(year == 2020, 
         candidate == "BIDEN, JOSEPH R. JR" | candidate == "TRUMP, DONALD J.") %>% 
  mutate(election_result = candidatevotes/totalvotes,
         candidate = str_replace_all(candidate,c("BIDEN, JOSEPH R. JR"),c("Biden\n(2020)")),
         candidate = str_replace_all(candidate,c("TRUMP, DONALD J."),c("Trump\n(2020)"))) %>%
  rename(state_label = state_po) %>%
  select(state,state_label,state_fips,candidate,election_result) %>%
  spread(candidate, election_result) %>%
  mutate(election_result = `Biden\n(2020)` - `Trump\n(2020)`) %>%
  select(state_label, election_result)


# Formatting CCES respondents by state as a table, to see how much each state contributed to the national total
table20_respondents <- svytable(~state_label, CCES20_weight) %>%
  as.data.frame() %>%
  mutate(cces_estimate = 100*(Freq/sum(Freq))) %>%
  select(-Freq)
table20_respondents$state_label <- state.abb[match(table20_respondents$state_label,state.name)]
table20_respondents[9,1] <- "DC"


# Formatting 2020 election by state as a table, to see how much each state contributed to the national total
electionrespondents_20 <- electionresults_all %>%
  filter(year == 2020, 
         candidate == "BIDEN, JOSEPH R. JR" | candidate == "TRUMP, DONALD J.") %>%
  rename(state_label = state_po)
votes_2020 <- sum(electionrespondents_20$totalvotes)/2

electionrespondents_20 <- electionrespondents_20 %>%
  group_by(state_label) %>%
  summarize(election_result = 100*(median(totalvotes)/votes_2020))


# Merging 2020 CCES estimates with election results  
results_vs_cces <- merge(electionresults_20,table20_bystate, by = "state_label")

results_vs_cces <- results_vs_cces %>%         # in which states was the CCES closest to the final electoral margin?
  mutate(cces_error        = 100*(election_result - cces_estimate),
         cces_error_binned = ifelse(cces_error >= -2.5 & cces_error <= 0, "Biden +1",
                             ifelse(cces_error < -2.5 & cces_error >= -5, "Biden +2.5",
                             ifelse(cces_error < -5 & cces_error >= -7.5, "Biden +5",
                             ifelse(cces_error < -7.5 & cces_error >= -100, "Biden +7.5 or greater",
                             ifelse(cces_error > 0 & cces_error <= 2.5, "Trump +1",
                             ifelse(cces_error > 2.5 & cces_error <= 5, "Trump +2.5",
                             ifelse(cces_error > 5 & cces_error <= 7.5, "Trump +5",
                             ifelse(cces_error > 7.5 & cces_error <= 100, "Trump +7.5 or greater","Within 1 point")))))))))
results_vs_cces$cces_error_binned <- factor(results_vs_cces$cces_error_binned, levels=c("Biden +7.5 or greater", "Biden +5", "Biden +2.5", "Biden +1", "Within 1 point","Trump +1", "Trump +2.5", "Trump +5", "Trump +7.5 or greater"))

pop_vote_vs_cces <- table20_respondents %>%    # in which states did the CCES over- or undersample respondents?
  merge(electionrespondents_20, by = "state_label") %>%
  mutate(cces_error        = election_result - cces_estimate,
         cces_error_binned = ifelse(cces_error >= -0.2 & cces_error <= 0, "Oversampled by 0.2 points",
                             ifelse(cces_error < -0.2 & cces_error >= -0.4, "Oversampled by 0.4 points",
                             ifelse(cces_error < -0.4 & cces_error >= -0.6, "Oversampled by 0.6 points",
                             ifelse(cces_error < -0.6 & cces_error >= -10, "Oversampled by 0.8+ points",
                             ifelse(cces_error > 0 & cces_error <= 0.2, "Undersampled by 0.2 points",
                             ifelse(cces_error > 0.2 & cces_error <= 0.4, "Undersampled by 0.4 points",
                             ifelse(cces_error > 0.4 & cces_error <= 0.6, "Undersampled by 0.6 points",
                             ifelse(cces_error > 0.6 & cces_error <= 10, "Undersampled by 0.8+ points","Within 0.2 points")))))))))
pop_vote_vs_cces$cces_error_binned <- factor(pop_vote_vs_cces$cces_error_binned, levels=c("Oversampled by 0.8+ points", "Oversampled by 0.6 points", "Oversampled by 0.4 points", "Oversampled by 0.2 points", "Within 0.2 points","Undersampled by 0.2 points", "Undersampled by 0.4 points", "Undersampled by 0.6 points", "Undersampled by 0.8+ points"))




#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ###
# Visualizing the results --------------------------------------------------------------
#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ###

# Setup 

# Getting a simple shapefile of U.S. states 
shape <- usmap::us_map()
shape$state_label <- shape$abbr

shape_and_results  <- merge(shape, results_vs_cces, by = "state_label")
shape_and_sampling <- merge(shape, pop_vote_vs_cces, by = "state_label") 


# Setting up themes: First general guidelines; Then barchart-specific additions; Then linechart-specific additions
theme_mbw <- theme(text = element_text(family = "Trebuchet MS", color = "#1c1c1c"),
                   plot.title = element_text(size = 18, face = "bold"),
                   plot.subtitle = element_text(size = 11),
                   plot.caption = element_text(size = 7, face = "italic", vjust = -1),
                   plot.margin = unit(c(1,1,1,1),"cm"))

theme_bar <- theme(axis.ticks = element_blank(),
                   axis.title = element_blank(),
                   panel.background = element_rect(fill = "white", size = 0.5, linetype = "solid") ,
                   panel.grid.major = element_line(size = 0.5, color = "#c7c7c7"),
                   panel.grid.major.x = element_blank(),
                   legend.position = "none",
                   strip.text.x = element_text(face ="bold", size = 17),
                   strip.background = element_rect(fill = "White"))

theme_line <- theme(axis.ticks = element_blank(),
                   axis.title = element_blank(),
                   axis.text.x = element_text(size = 8.5),
                   panel.background = element_rect(fill = "white", size = 0.5, linetype = "solid") ,
                   panel.grid.major = element_line(size = 0.5, color = "#c7c7c7"),
                   panel.grid.major.x = element_blank(),
                   legend.position = "top",
                   plot.margin = unit(c(0,1,1,1),"cm"),
                   strip.text.x = element_text(face ="bold", size = 17),
                   strip.background = element_rect(fill = "White"))


# Finally, plots

# Gender: Base barplot; Add color to title; Base line graph; Combine 
plot_gender_bar <- ggplot(data = tableall_gender[tableall_gender$cycle == 2016 | tableall_gender$cycle == 2020,], aes(x = candidate, y = Freq)) +
  geom_bar(stat = "identity", aes(fill = candidate), color = "black") +
  labs(title = "The gender gap stayed steady in 2020...",
       subtitle = "Democratic and Republican support in the 2016 and 2020 elections,\nby gender\n",
       caption = "\nSource: Cooperative Congressional Election Study (CCES)") +
  scale_y_continuous(breaks = c(0,.25,.50,.75,1),labels = scales::percent) +
  facet_wrap(~gender_label, nrow = 1, scales = "free_x") +
  theme_mbw +
  theme_bar +
  theme(axis.text.x = element_text(size = 7.25)) +
  scale_fill_manual(values = c("#5dbaf5","#ff6b6e","#0073bb","#b04143"))

texttitle <- textGrob(expression("Support for " * phantom(bold("Democratic ")) * "and" * phantom(bold(" Republican")) * " presidential candidates by gender"), x = 0.45, y = 0.21, gp = gpar(col = "black", family = "Trebuchet MS"))
textdem <- textGrob(expression(phantom("Support for ") * bold("Democratic ") * phantom(" and  Republican presidential candidates by gender")), x = 0.45, y = 0.21, gp = gpar(col = "#0073bb", family = "Trebuchet MS"))
textrep <- textGrob(expression(phantom("Support for Democratic  and ") * bold(" Republican") * phantom(" presidential candidates by gender")), x = 0.45, y = 0.21, gp = gpar(col = "#ff6b6e", family = "Trebuchet MS"))

line_gender_text <- ggplot(data = tableall_gender, aes(x = cycle, y = Freq)) +
  geom_line(color = "white") +
  labs(title = "...similar to longer-term gender patterns.") +
  scale_y_continuous(breaks = c(0,.25,.50,.75,1), limits = c(0.2,0.8),labels = scales::percent) +
  scale_x_continuous(breaks = c(2008,2012,2016,2020), limits = c(2007,2021)) +
  annotation_custom(grobTree(texttitle,textdem,textrep)) +
  theme_void() +
  theme_mbw +
  theme(plot.title = element_text(size = 17, face = "bold", vjust = -1))

line_gender_facet <- ggplot(data = tableall_gender, aes(x = cycle, y = Freq)) +
  geom_line(size = 1.25, aes(color = party)) +
  geom_point(size = 1.6, color = "black", aes(fill = party)) +
  geom_text_repel(aes(label =  round(Freq*100,0), size = 0.4, color = party, family = "Trebuchet MS")) +
  labs(caption = "\nSource: Cooperative Congressional Election Study (2008, 2012, 2016, 2020)") +
  scale_x_continuous(breaks = c(2008,2012,2016,2020), limits = c(2007,2021)) +
  scale_y_continuous(breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9), limits = c(0.25,0.75),labels = scales::percent) +
  coord_cartesian(clip = "off") +
  theme_mbw +
  theme_line + 
  theme(legend.position = "none",
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5, vjust = -8),
        plot.caption = element_text(size = 7)) +
  scale_color_manual(values = c("#0073bb","#ff6b6e")) +
  facet_wrap(~gender_label, nrow = 1, scales = "free_x")

line_gender_final <- plot_grid(line_gender_text,line_gender_facet, nrow = 2, rel_heights = c(28/100,72/100))

rm(line_gender_text,line_gender_facet,texttitle,textdem,textrep)


# Education: Base barplot; Add color to title; Base line graph; Combine
plot_education_bar <- ggplot(data = tableall_education[tableall_education$college_degree == "Bachelor's Degree" & tableall_education$cycle >= 2016 & tableall_education$cycle <= 2020, ], aes(x = candidate, y = Freq)) +
  geom_bar(stat = "identity", aes(fill = candidate), color = "black") +
  labs(title = "The education gap grew slightly larger...",
       subtitle = "Democratic and Republican support in the 2016 and 2020 elections,\namong those with a bachelor's degree\n",
       caption = "\nSource: Cooperative Congressional Election Study (CCES)") +
  scale_y_continuous(breaks = c(0,.25,.50,.75,1),labels = scales::percent) +
  theme_mbw +
  theme_bar +
  theme(axis.text.x = element_text(size = 9.25)) +
  scale_fill_manual(values = c("#5dbaf5","#ff6b6e","#0073bb","#b04143"))

texttitle <- textGrob(expression(" Support for " * phantom(bold("Democratic ")) * "and" * phantom(bold(" Republican")) * " presidential candidates by education"), x = 0.46, y = 0.21, gp = gpar(col = "black", family = "Trebuchet MS"))
textdem <- textGrob(expression(phantom(" Support for ") * bold("Democratic ") * phantom(" and  Republican presidential candidates by education")), x = 0.46, y = 0.21, gp = gpar(col = "#0073bb", family = "Trebuchet MS"))
textrep <- textGrob(expression(phantom(" Support for Democratic  and ") * bold(" Republican") * phantom(" presidential candidates by education")), x = 0.46, y = 0.21, gp = gpar(col = "#ff6b6e", family = "Trebuchet MS"))

line_education_text <- ggplot(data = tableall_education, aes(x = cycle, y = Freq)) +
  geom_line(color = "white") +
  labs(title = "...as those with a college degree become more Democratic.") +
  scale_y_continuous(breaks = c(0,.25,.50,.75,1), limits = c(0.2,0.8),labels = scales::percent) +
  scale_x_continuous(breaks = c(2008,2012,2016,2020), limits = c(2007,2021)) +
  annotation_custom(grobTree(texttitle,textdem,textrep)) +
  theme_void() +
  theme_mbw +
  theme(plot.title = element_text(size = 17, face = "bold", vjust = -1))

line_education_facet <- ggplot(data = tableall_education, aes(x = cycle, y = Freq)) +
  geom_line(size = 1.25, aes(color = party)) +
  geom_point(size = 1.6, color = "black", aes(fill = party)) +
  geom_text_repel(aes(label =  round(Freq*100,0), size = 0.4, color = party, family = "Trebuchet MS")) +
  labs(caption = "\nSource: Cooperative Congressional Election Study (2008, 2012, 2016, 2020)") +
  scale_x_continuous(breaks = c(2008,2012,2016,2020), limits = c(2007,2021)) +
  scale_y_continuous(breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9), limits = c(0.25,0.75),labels = scales::percent) +
  coord_cartesian(clip = "off") +
  theme_mbw +
  theme_line + 
  theme(legend.position = "none",
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5, vjust = -8),
        plot.caption = element_text(size = 7)) +
  scale_color_manual(values = c("#0073bb","#ff6b6e")) +
  facet_wrap(~college_degree, nrow = 1, scales = "free_x")

line_education_final <- plot_grid(line_education_text,line_education_facet, nrow = 2, rel_heights = c(28/100,72/100))

rm(line_education_text,line_education_facet,texttitle,textdem,textrep)


# Race: Base barplot; Add color to title; Base line graph; Combine
plot_race_bar <- ggplot(data = tableall_race[tableall_race$race_recoded == "Hispanic" & tableall_race$cycle >= 2016 & tableall_race$cycle <= 2020, ], aes(x = candidate, y = Freq)) +
  geom_bar(stat = "identity", aes(fill = candidate), color = "black") +
  labs(title = "Trump gained among Hispanic voters...",
       subtitle = "Democratic and Republican support in the 2016 and 2020 elections,\namong Hispanic voters\n",
       caption = "\nSource: Cooperative Congressional Election Study (CCES)") +
  scale_y_continuous(breaks = c(0,.25,.50,.75,1),labels = scales::percent) +
  theme_mbw +
  theme_bar +
  theme(axis.text.x = element_text(size = 9.25)) +
  scale_fill_manual(values = c("#5dbaf5","#ff6b6e","#0073bb","#b04143"))

texttitle <- textGrob(expression("Support for " * phantom(bold("Democratic ")) * "and" * phantom(bold(" Republican")) * " presidential candidates by race"), x = 0.43, y = 0.21, gp = gpar(col = "black", family = "Trebuchet MS"))
textdem <- textGrob(expression(phantom("Support for ") * bold("Democratic ") * phantom(" and  Republican presidential candidates by race")), x = 0.43, y = 0.21, gp = gpar(col = "#0073bb", family = "Trebuchet MS"))
textrep <- textGrob(expression(phantom("Support for Democratic  and ") * bold(" Republican") * phantom(" presidential candidates by race")), x = 0.43, y = 0.21, gp = gpar(col = "#ff6b6e", family = "Trebuchet MS"))

line_race_text <- ggplot(data = tableall_age_bucket, aes(x = cycle, y = Freq)) +
  geom_line(color = "white") +
  labs(title = "...as Biden underperformed Obama across most groups.") +
  scale_y_continuous(breaks = c(0,.25,.50,.75,1), limits = c(0.2,0.8),labels = scales::percent) +
  scale_x_continuous(breaks = c(2008,2012,2016,2020), limits = c(2007,2021)) +
  annotation_custom(grobTree(texttitle,textdem,textrep)) +
  theme_void() +
  theme_mbw +
  theme(plot.title = element_text(size = 17, face = "bold", vjust = -1))

line_race_facet <- ggplot(data = tableall_race, aes(x = cycle, y = Freq)) +
  geom_line(size = 1.25, aes(color = party)) +
  geom_point(size = 1.6, color = "black", aes(fill = party)) +
  geom_text_repel(aes(label =  round(Freq*100,0), size = 0.4, color = party, family = "Trebuchet MS")) +
  labs(caption = "\nSource: Cooperative Congressional Election Study (2008, 2012, 2016, 2020)") +
  scale_x_continuous(breaks = c(2008,2012,2016,2020), limits = c(2007,2021)) +
  scale_y_continuous(breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9), limits = c(0,0.99),labels = scales::percent) +
  coord_cartesian(clip = "off") +
  theme_mbw +
  theme_line + 
  theme(legend.position = "none",
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5, vjust = -8),
        plot.caption = element_text(size = 7)) +
  scale_color_manual(values = c("#0073bb","#ff6b6e")) +
  facet_wrap(~race_recoded, nrow = 1, scales = "free_x")

line_race_final <- plot_grid(line_race_text,line_race_facet, nrow = 2, rel_heights = c(28/100,72/100))

rm(line_race_text,line_race_facet,texttitle,textdem,textrep)


# Age: Base barplot; Add color to title; Base line graph; Combine
plot_age_bar <- ggplot(data = tableall_age_bucket[c(17:18,23:26,31:32),], aes(x = candidate, y = Freq)) +
  geom_bar(stat = "identity", aes(fill = candidate), color = "black") +
  labs(title = "Biden gained among the oldest and youngest voters...",
       subtitle = "Democratic and Republican support in the 2016 and 2020 elections,\nwith certain age brackets highlighted\n",
       caption = "\nSource: Cooperative Congressional Election Study (CCES)") +
  scale_y_continuous(breaks = c(0,.25,.50,.75,1),labels = scales::percent) +
  facet_wrap(~age_bucket, nrow = 1, scales = "free_x") +
  theme_mbw + 
  theme_bar +
  theme(axis.text.x = element_text(size = 7.25)) +
  scale_fill_manual(values = c("#5dbaf5","#ff6b6e","#0073bb","#b04143"))

texttitle <- textGrob(expression("Support for " * phantom(bold("Democratic ")) * "and" * phantom(bold(" Republican")) * " presidential candidates by age group"), x = 0.475, y = 0.21, gp = gpar(col = "black", family = "Trebuchet MS"))
textdem <- textGrob(expression(phantom("Support for ") * bold("Democratic ") * phantom(" and  Republican presidential candidates by age group")), x = 0.475, y = 0.21, gp = gpar(col = "#0073bb", family = "Trebuchet MS"))
textrep <- textGrob(expression(phantom("Support for Democratic  and ") * bold(" Republican") * phantom(" presidential candidates by age group")), x = 0.475, y = 0.21, gp = gpar(col = "#ff6b6e", family = "Trebuchet MS"))

line_age_text <- ggplot(data = tableall_age_bucket, aes(x = cycle, y = Freq)) +
  geom_line(color = "white") +
  labs(title = "...but older voters still tend to prefer Republicans.") +
  scale_y_continuous(breaks = c(0,.25,.50,.75,1), limits = c(0.2,0.8),labels = scales::percent) +
  scale_x_continuous(breaks = c(2008,2012,2016,2020), limits = c(2007,2021)) +
  annotation_custom(grobTree(texttitle,textdem,textrep)) +
  theme_void() +
  theme_mbw +
  theme(plot.title = element_text(size = 17, face = "bold", vjust = -1))

line_age_facet <- ggplot(data = tableall_age_bucket, aes(x = cycle, y = Freq)) +
  geom_line(size = 1.25, aes(color = party)) +
  geom_point(size = 1.6, color = "black", aes(fill = party)) +
  geom_text_repel(aes(label =  round(Freq*100,0), size = 0.4, color = party, family = "Trebuchet MS")) +
  labs(caption = "\nSource: Cooperative Congressional Election Study (2008, 2012, 2016, 2020)") +
  scale_x_continuous(breaks = c(2008,2012,2016,2020), limits = c(2007,2021)) +
  scale_y_continuous(breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9), limits = c(0,0.99),labels = scales::percent) +
  coord_cartesian(clip = "off") +
  theme_mbw +
  theme_line + 
  theme(legend.position = "none",
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5, vjust = -8),
        plot.caption = element_text(size = 7)) +
  scale_color_manual(values = c("#0073bb","#ff6b6e")) +
  facet_wrap(~age_bucket, nrow = 1, scales = "free_x") 

line_age_final <- plot_grid(line_age_text,line_age_facet, nrow = 2, rel_heights = c(28/100,72/100))

rm(line_age_text,line_age_facet,texttitle,textdem,textrep)


# Map showing the states in which the CCES was closest to the final electoral margin
plot_error_map <- ggplot(data = shape_and_results) + 
  geom_polygon(aes(x = x, y = y, group = group, fill = cces_error_binned), color = "black") +
  labs(title = "The CCES overestimated Biden in most states...",
       subtitle = "Difference between the actual results of the 2020 election\nand CCES estimates\n",
       caption = "\nSources: Cooperative Congressional Election Study (CCES); MIT Election Lab") +
  labs(fill = "CCES Error\n") +
  theme_void() +
  theme_mbw + 
  theme(legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold")) +
  scale_fill_manual(values = c("#171c63","#3b48f7","#75a8ff","#d4e7ff","#fcc0c0","#ff6161","#ad0000"))


# Map showing the states in which the CCES over- or undersampled respondents 
plot_sampling_map <- ggplot(data = shape_and_sampling) + 
  geom_polygon(aes(x = x, y = y, group = group, fill = cces_error_binned), color = "black") +
  labs(title = "...but still sampled the electorate fairly well.",
       subtitle = "Difference between the % of total nationwide ballots cast per state in 2020 \nand equivalent CCES sampling percentages\n",
       caption = "\nSources: Cooperative Congressional Election Study (CCES); MIT Election Lab") +
  labs(fill = "CCES Error\n") +
  theme_void() +
  theme_mbw + 
  theme(legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold")) +
  scale_fill_manual(values = c("#580085","#9d35b0","#d69df5","#ddddee","#c7ffeb","#7affd0","#16cc8c","#006340"))




#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ###
# Dafting the text and placing the plots ---------------------------------------
#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ###
```

Joe Biden's victory over Donald Trump in the 2020 election came thanks to a broad coalition...sort of. But what exactly did that coalition look like? And how did it compare to that of Hillary Clinton in 2016, or previous Democratic presidential candidates? These answers and more can be found in the [Cooperative Election Study](https://cces.gov.harvard.edu/).

The Cooperative Election Study, also known as the Cooperative Congressional Election Study or CCES, is a comprehensive survey of over 50,000 respondents across the United States, administered online via YouGov as part of a joint effort between dozens of different academic and research institutions. Although the CCES is conducted annually, its election-year installments are special in that they're fielded in two waves: one before the election, and one after. Due to its large sample size and vote validation after the fact, the CCES is [considered to be](https://fivethirtyeight.com/videos/be-wary-of-exit-polls-this-year-well-and-all-years/) a more rigorous alternative to the exit polls taken on Election Day. At the very least, [it is widely agreed](https://centerforpolitics.org/crystalball/articles/another-look-back-at-2016/) that the CCES is a reliable reference for anyone curious about who voted for whom on the Tuesday next after the first Monday last November.

The following visualizations will seek to give additional context to the recently released [2020 Cooperative Election Study post-election wave](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi%3A10.7910/DVN/E9N6PH) by analyzing support for Biden and Trump across various demographic groups, and then comparing those to the equivalent estimates from the 2016 Cooperative Congressional Election Study. All data has been reweighted using the information provided by the CCES. 


## Visualizations 1 & 2: CCES Estimates vs. 2020 Results
Before diving in, it's important to remember that the Cooperative Election Study is still just a poll. As a result, its estimates don't always line up with the real outcome of the election. The first map compares the state-level estimates from the 2020 CCES to the true results, whereas the second map compares the proportion of a state's respondents to its contribution to the national popular vote:

```{r dpi = 175}
plot_error_map
plot_sampling_map
```

As demonstrated above, the CCES was far from flawless last November. On average, the state-level results overestimated support for Joe Biden by approximately 2 to 4 points, ultimately overshooting his actual vote share in 35 states and the District of Columbia. But that kind of error wasn't unique to this one survey; by and large, [most pollsters had a rough go in 2020](https://fivethirtyeight.com/features/the-death-of-polling-is-greatly-exaggerated/). While it will still [take time](https://www.aapor.org/Publications-Media/Press-Releases/AAPOR-Convenes-Task-Force-to-Formally-Examine-Poll.aspx) for experts in the field to more critically diagnose what went wrong, projects such as the CCES help to facilitate this work with its own demographic estimates of the  electorate. Interestingly, the state-by-state breakdown of CCES sample matched closely to each state's eventual share of the national popular vote (For example, California comprised 8.4% of the CCES sample while contributing to 11% of the national popular vote â€” this discrepancy of 2.6 points was by far the largest recorded).

## Visualizations 3 & 4: Election Results by Gender
Although politics in the United States have become increasingly polarized [over the last two decades especially](https://www.pewresearch.org/politics/2019/12/17/in-a-politically-polarized-era-sharp-divides-in-both-partisan-coalitions/), one demographic gap has been drawn out along party lines for the better part of the [past 40 years](https://www.pewresearch.org/politics/2019/12/17/in-a-politically-polarized-era-sharp-divides-in-both-partisan-coalitions/). Indeed, women continued to vote for Democrats at higher rates than they did for Republicans in 2020, even more so than in 2016 â€” while support among men improved for both Trump and Biden. Per the 2016 CCES, Hillary Clinton earned 53 percent of women voters, compared to 42 percent for Donald Trump. Joe Biden further built on this advantage four years later, earning a slightly larger share (56-43) over Trump relative to Clinton. In both 2016 and 2020, Trump earned more support among men. 

```{r dpi = 175}
plot_gender_bar
line_gender_final
```


## Visualizations 5 & 6: Election Results by Education
One of the [big stories](https://www.brookings.edu/research/americas-electoral-future_2018/) of the 2016 election was Donald Trump's strong support among voters without a college degree: the 2016 CCES approximates that he won this group 51-44 â€” and he did even better among white voters without a college degree in particular. Likewise, Hillary Clinton was substantially more popular than Trump (55-38) among those who said they had at least a bachelor's degree.  

According to the 2020 CCES, these gaps grew even larger. While Trump's support among voters without a college degree hovered at a similar position in both 2016 and 2020, Joe Biden's advantage among voters with a college degree grew to around 20 points, a marked improvement from Clinton's already impressive showing four years earlier. These differences raise questions about the long-term trajectory of this educational divide: in the span of just a few cycles, the gap has gone from a [relative non-factor in elections](https://www.pewresearch.org/fact-tank/2016/09/15/educational-divide-in-vote-preferences-on-track-to-be-wider-than-in-recent-elections/) to one of the [most important demographic trends of all](https://www.nytimes.com/2020/05/12/upshot/polls-2020-trump-biden.html).

```{r dpi = 175}
plot_education_bar
line_education_final
```


## Visualizations 7 & 8: Election Results by Race
While Donald Trump ultimately fell short of a second term, he managed to win [12 million more votes](https://uselectionatlas.org/RESULTS/index.html) in 2020 than he did in 2016. Part of this increased support might have come from minority voters. Compared to Hillary Clinton's performance in 2016, and especially Barack Obama's showings in 2008 and 2012, Joe Biden failed to make serious gains among most groups â€” and it appears he may have lost voters overall.

Many of the differences between the 2016 and 2020 CCES are too close to tell for certain, but there's other evidence in favor of the theory that Trump gained  support among certain minority voters. Areas including [Miami-Dade County in Florida](https://twitter.com/xxxneonslavexxx/status/1328853223214559233) and [the Rio Grande Valley in Texas](https://www.theguardian.com/commentisfree/2020/nov/24/the-10-swing-state-counties-that-tell-the-story-of-the-2020-election), both of which are areas with high Hispanic populations, veered toward Trump by as much as 20 or 30 points last November; the latest CCES estimates, on the other hand, showed Trump gaining just a few points among Hispanic voters overall between 2016 and 2020. To be sure, the possibility that Hispanic voters were underrepresented in 2020 pre-election polls is [one that pollsters recognize](https://www.nytimes.com/2020/11/10/upshot/polls-what-went-wrong.html) â€” it also doesn't help that the CCES lists only 'Hispanic' as an answer on its questionnaire, rather than providing more specific choices (such as nationality) that might more faithfully capture the contours of this demographic group. 

```{r dpi = 175}
plot_race_bar
line_race_final
```


## Visualizations 9 & 10: Election Results by Age
In the lead-up to the 2020 election, there was much [chatter](https://www.brookings.edu/blog/the-avenue/2020/10/28/older-voters-may-secure-a-biden-victory-in-2020s-swing-states/) online about Joe Biden's strong support among older voters. Although the 2016 CCES suggested that Donald Trump carried voters over the age of 65 by 13 points nationwide against Hillary Clinton, [some state-level polling](https://int.nyt.com/data/documenttools/flpa-0930-crosstabs/16c21b7ab34ed4d1/full.pdf) conducted weeks before the 2020 race showed Joe Biden ahead among this group. But in the end, that support didn't fully materialize, as the 2020 CCES post-election survey suggested Trump won among voters over 65 by 9 points against Biden, continuing a streak of sorts for Republican presidential candidates.

That said, relative to Clinton four years before, Biden still made improvements among older voters, and among _most_ age groups for that matter. This boost was particularly prominent among voters aged 18-34: Clinton won them by 20 points, Biden won them by approximately 30 points.

```{r dpi = 175}
plot_age_bar
line_age_final
```


## Closing Thoughts
The 2020 election certainly had its surprises. But six months later, more information has allowed some of those questions to be answered.

Using data from the 2016 and 2020 post-election waves of the Cooperative Election Study, the preceding visualizations have compared support for Hillary Clinton, Joe Biden, and Donald Trump by gender, educational attainment, race, and age. This preliminary analysis suggests that Biden improved upon Clinton's margins in groups such as younger voters and voters with a college degree. While certain other estimates from the CCES do not appear to be substantively different between both elections years, these findings are not conclusive, and future research could serve to establish clarity on these issues.

